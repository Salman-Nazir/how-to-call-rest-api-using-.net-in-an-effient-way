using FluentAssertions;
using System;
using System.Net;
using System.Net.Http;
using System.Threading;
using System.Threading.Tasks;
using Xunit;

namespace APIClientForEconomic
{
    public class EconomicClientTest
    {
        [Fact]
        public async Task EconomicClientTest_GetCustomer()
        {
            var handlerMock = new MockHttpMessageHandler(HttpStatusCode.OK,
                @"{ ""customerNumber"": 1, ""currency"": ""DKK"", ""paymentTerms"": { ""paymentTermsNumber"": 1, ""self"": ""https://restapi.e-conomic.com/payment-terms/1?demo=true"" }, ""customerGroup"": { ""customerGroupNumber"": 1, ""self"": ""https://restapi.e-conomic.com/customer-groups/1?demo=true"" }, ""address"": ""Vejen 1"", ""balance"": 9736466.26, ""dueAmount"": 9611908.92, ""corporateIdentificationNumber"": ""DK12345678"", ""city"": ""Storeby"", ""country"": ""Denmark"", ""email"": ""jo+billing@addwish.com"", ""name"": ""Addwish test 1563882396474"", ""zip"": ""1234"", ""vatZone"": { ""vatZoneNumber"": 1, ""self"": ""https://restapi.e-conomic.com/vat-zones/1?demo=true"" }, ""lastUpdated"": ""2019-07-23T11:46:36Z"", ""contacts"": ""https://restapi.e-conomic.com/customers/1/contacts?demo=true"", ""templates"": { ""invoice"": ""https://restapi.e-conomic.com/customers/1/templates/invoice?demo=true"", ""invoiceLine"": ""https://restapi.e-conomic.com/customers/1/templates/invoiceline?demo=true"", ""self"": ""https://restapi.e-conomic.com/customers/1/templates?demo=true"" }, ""totals"": { ""drafts"": ""https://restapi.e-conomic.com/invoices/totals/drafts/customers/1?demo=true"", ""booked"": ""https://restapi.e-conomic.com/invoices/totals/booked/customers/1?demo=true"", ""self"": ""https://restapi.e-conomic.com/customers/1/totals?demo=true"" }, ""deliveryLocations"": ""https://restapi.e-conomic.com/customers/1/delivery-locations?demo=true"", ""invoices"": { ""drafts"": ""https://restapi.e-conomic.com/customers/1/invoices/drafts?demo=true"", ""booked"": ""https://restapi.e-conomic.com/customers/1/invoices/booked?demo=true"", ""self"": ""https://restapi.e-conomic.com/customers/1/invoices?demo=true"" }, ""metaData"": { ""delete"": { ""description"": ""Delete this customer."", ""href"": ""https://restapi.e-conomic.com/customers/1?demo=true"", ""httpMethod"": ""delete"" }, ""replace"": { ""description"": ""Replace this customer."", ""href"": ""https://restapi.e-conomic.com/customers/1?demo=true"", ""httpMethod"": ""put"" } }, ""self"": ""https://restapi.e-conomic.com/customers/1?demo=true"" }");

            var httpClient = new HttpClient(handlerMock)
            {
                BaseAddress = new Uri("https://restapi.e-conomic.com/"),
            };

            var subjectUnderTest = new EconomicClient(httpClient, "demo", "demo");
            var result = await subjectUnderTest.GetEconomicCustomer(1);

            result.Should().NotBeNull();
            result.CustomerNumber.Should().Be(1);
            handlerMock.NumberOfCalls.Should().Be(1);
            handlerMock.Request.Method.Should().Be(HttpMethod.Get);
            handlerMock.Request.RequestUri.Should().Be(new Uri("https://restapi.e-conomic.com/customers/1"));
        }

        [Fact]
        public async Task EconomicClientTest_GetContacts()
        {
            var handlerMock = new MockHttpMessageHandler(HttpStatusCode.OK,
               @"{ ""collection"": [ { ""customerContactNumber"": 314, ""email"": ""sj@morningtrain-test.dk"", ""name"": ""Simon Testersen"", ""customer"": { ""customerNumber"": 1, ""self"": ""https://restapi.e-conomic.com/customers/1?demo=true"" }, ""sortKey"": 7, ""self"": ""https://restapi.e-conomic.com/customers/1/contacts/314?demo=true"" }, { ""customerContactNumber"": 315, ""email"": ""sj@morningtrain-test.dk"", ""name"": ""Simon Testersen"", ""customer"": { ""customerNumber"": 1, ""self"": ""https://restapi.e-conomic.com/customers/1?demo=true"" }, ""sortKey"": 8, ""self"": ""https://restapi.e-conomic.com/customers/1/contacts/315?demo=true"" }, { ""customerContactNumber"": 317, ""email"": ""test@example.com"", ""name"": ""kontaktperson"", ""customer"": { ""customerNumber"": 1, ""self"": ""https://restapi.e-conomic.com/customers/1?demo=true"" }, ""sortKey"": 9, ""self"": ""https://restapi.e-conomic.com/customers/1/contacts/317?demo=true"" } ], ""pagination"": { ""maxPageSizeAllowed"": 1000, ""skipPages"": 0, ""pageSize"": 20, ""results"": 3, ""resultsWithoutFilter"": 3, ""firstPage"": ""https://restapi.e-conomic.com/customers/1/contacts?demo=true&skippages=0&pagesize=20"", ""lastPage"": ""https://restapi.e-conomic.com/customers/1/contacts?demo=true&skippages=0&pagesize=20"" }, ""self"": ""https://restapi.e-conomic.com/customers/1/contacts?demo=true"" }");

            var httpClient = new HttpClient(handlerMock)
            {
                BaseAddress = new Uri("https://restapi.e-conomic.com/"),
            };

            var subjectUnderTest = new EconomicClient(httpClient, "demo", "demo");
            var result = await subjectUnderTest.GetContacts(1);

            result.Should().NotBeNull();
            result.Count.Should().Be(3);
            handlerMock.NumberOfCalls.Should().Be(1);
            handlerMock.Request.Method.Should().Be(HttpMethod.Get);
            handlerMock.Request.RequestUri.Should().Be(new Uri("https://restapi.e-conomic.com/customers/1/contacts"));
        }

        [Fact]
        public async Task EconomicClientTest_GetTransactions()
        {
            var handlerMock = new MockHttpMessageHandler(HttpStatusCode.OK,
                   @"{ ""collection"": [ { ""account"": { ""accountNumber"": 5600, ""self"": ""https://restapi.e-conomic.com/accounts/5600?demo=true"" }, ""amount"": 118750.00, ""amountInBaseCurrency"": 118750.00, ""currency"": ""DKK"", ""date"": ""2017-02-03"", ""dueDate"": ""2017-02-17"", ""entryNumber"": 2262, ""text"": ""Notes"", ""entryType"": ""customerInvoice"", ""voucherNumber"": 10129, ""customer"": { ""customerNumber"": 1, ""self"": ""https://restapi.e-conomic.com/customers/1?demo=true"" }, ""bookedInvoice"": { ""bookedInvoiceNumber"": 10129, ""self"": ""https://restapi.e-conomic.com/invoices/booked/10129?demo=true"" }, ""invoiceNumber"": 10129, ""remainder"": 118750.00, ""remainderInBaseCurrency"": 118750.00, ""self"": ""https://restapi.e-conomic.com/entries/2262?demo=true"" }, { ""account"": { ""accountNumber"": 5600, ""self"": ""https://restapi.e-conomic.com/accounts/5600?demo=true"" }, ""amount"": 118750.00, ""amountInBaseCurrency"": 118750.00, ""currency"": ""DKK"", ""date"": ""2017-02-03"", ""dueDate"": ""2017-02-17"", ""entryNumber"": 2265, ""text"": ""Notes"", ""entryType"": ""customerInvoice"", ""voucherNumber"": 10130, ""customer"": { ""customerNumber"": 1, ""self"": ""https://restapi.e-conomic.com/customers/1?demo=true"" }, ""bookedInvoice"": { ""bookedInvoiceNumber"": 10130, ""self"": ""https://restapi.e-conomic.com/invoices/booked/10130?demo=true"" }, ""invoiceNumber"": 10130, ""remainder"": 118750.00, ""remainderInBaseCurrency"": 118750.00, ""self"": ""https://restapi.e-conomic.com/entries/2265?demo=true"" }, { ""account"": { ""accountNumber"": 5600, ""self"": ""https://restapi.e-conomic.com/accounts/5600?demo=true"" }, ""amount"": 10.00, ""amountInBaseCurrency"": 10.00, ""currency"": ""DKK"", ""date"": ""2017-04-21"", ""dueDate"": ""2017-05-05"", ""entryNumber"": 2710, ""text"": ""Invoice"", ""entryType"": ""customerInvoice"", ""voucherNumber"": 10280, ""customer"": { ""customerNumber"": 1, ""self"": ""https://restapi.e-conomic.com/customers/1?demo=true"" }, ""bookedInvoice"": { ""bookedInvoiceNumber"": 10280, ""self"": ""https://restapi.e-conomic.com/invoices/booked/10280?demo=true"" }, ""invoiceNumber"": 10280, ""remainder"": 10.00, ""remainderInBaseCurrency"": 10.00, ""self"": ""https://restapi.e-conomic.com/entries/2710?demo=true"" }, { ""account"": { ""accountNumber"": 5600, ""self"": ""https://restapi.e-conomic.com/accounts/5600?demo=true"" }, ""amount"": 10.00, ""amountInBaseCurrency"": 10.00, ""currency"": ""DKK"", ""date"": ""2017-04-21"", ""dueDate"": ""2017-05-05"", ""entryNumber"": 2712, ""text"": ""Invoice"", ""entryType"": ""customerInvoice"", ""voucherNumber"": 10281, ""customer"": { ""customerNumber"": 1, ""self"": ""https://restapi.e-conomic.com/customers/1?demo=true"" }, ""bookedInvoice"": { ""bookedInvoiceNumber"": 10281, ""self"": ""https://restapi.e-conomic.com/invoices/booked/10281?demo=true"" }, ""invoiceNumber"": 10281, ""remainder"": 10.00, ""remainderInBaseCurrency"": 10.00, ""self"": ""https://restapi.e-conomic.com/entries/2712?demo=true"" }, { ""account"": { ""accountNumber"": 5600, ""self"": ""https://restapi.e-conomic.com/accounts/5600?demo=true"" }, ""amount"": 10.00, ""amountInBaseCurrency"": 10.00, ""currency"": ""DKK"", ""date"": ""2017-04-21"", ""dueDate"": ""2017-05-05"", ""entryNumber"": 2714, ""text"": ""Invoice"", ""entryType"": ""customerInvoice"", ""voucherNumber"": 10282, ""customer"": { ""customerNumber"": 1, ""self"": ""https://restapi.e-conomic.com/customers/1?demo=true"" }, ""bookedInvoice"": { ""bookedInvoiceNumber"": 10282, ""self"": ""https://restapi.e-conomic.com/invoices/booked/10282?demo=true"" }, ""invoiceNumber"": 10282, ""remainder"": 10.00, ""remainderInBaseCurrency"": 10.00, ""self"": ""https://restapi.e-conomic.com/entries/2714?demo=true"" }, { ""account"": { ""accountNumber"": 5600, ""self"": ""https://restapi.e-conomic.com/accounts/5600?demo=true"" }, ""amount"": 10.00, ""amountInBaseCurrency"": 10.00, ""currency"": ""DKK"", ""date"": ""2017-04-21"", ""dueDate"": ""2017-05-05"", ""entryNumber"": 2716, ""text"": ""Invoice"", ""entryType"": ""customerInvoice"", ""voucherNumber"": 10283, ""customer"": { ""customerNumber"": 1, ""self"": ""https://restapi.e-conomic.com/customers/1?demo=true"" }, ""bookedInvoice"": { ""bookedInvoiceNumber"": 10283, ""self"": ""https://restapi.e-conomic.com/invoices/booked/10283?demo=true"" }, ""invoiceNumber"": 10283, ""remainder"": 10.00, ""remainderInBaseCurrency"": 10.00, ""self"": ""https://restapi.e-conomic.com/entries/2716?demo=true"" }, { ""account"": { ""accountNumber"": 5600, ""self"": ""https://restapi.e-conomic.com/accounts/5600?demo=true"" }, ""amount"": 10.00, ""amountInBaseCurrency"": 10.00, ""currency"": ""DKK"", ""date"": ""2017-04-21"", ""dueDate"": ""2017-05-05"", ""entryNumber"": 2718, ""text"": ""Invoice"", ""entryType"": ""customerInvoice"", ""voucherNumber"": 10284, ""customer"": { ""customerNumber"": 1, ""self"": ""https://restapi.e-conomic.com/customers/1?demo=true"" }, ""bookedInvoice"": { ""bookedInvoiceNumber"": 10284, ""self"": ""https://restapi.e-conomic.com/invoices/booked/10284?demo=true"" }, ""invoiceNumber"": 10284, ""remainder"": 10.00, ""remainderInBaseCurrency"": 10.00, ""self"": ""https://restapi.e-conomic.com/entries/2718?demo=true"" }, { ""account"": { ""accountNumber"": 5600, ""self"": ""https://restapi.e-conomic.com/accounts/5600?demo=true"" }, ""amount"": 10.00, ""amountInBaseCurrency"": 10.00, ""currency"": ""DKK"", ""date"": ""2017-04-21"", ""dueDate"": ""2017-05-05"", ""entryNumber"": 2720, ""text"": ""Invoice"", ""entryType"": ""customerInvoice"", ""voucherNumber"": 10285, ""customer"": { ""customerNumber"": 1, ""self"": ""https://restapi.e-conomic.com/customers/1?demo=true"" }, ""bookedInvoice"": { ""bookedInvoiceNumber"": 10285, ""self"": ""https://restapi.e-conomic.com/invoices/booked/10285?demo=true"" }, ""invoiceNumber"": 10285, ""remainder"": 10.00, ""remainderInBaseCurrency"": 10.00, ""self"": ""https://restapi.e-conomic.com/entries/2720?demo=true"" }, { ""account"": { ""accountNumber"": 5600, ""self"": ""https://restapi.e-conomic.com/accounts/5600?demo=true"" }, ""amount"": 10.00, ""amountInBaseCurrency"": 10.00, ""currency"": ""DKK"", ""date"": ""2017-04-21"", ""dueDate"": ""2017-05-05"", ""entryNumber"": 2722, ""text"": ""Invoice"", ""entryType"": ""customerInvoice"", ""voucherNumber"": 10286, ""customer"": { ""customerNumber"": 1, ""self"": ""https://restapi.e-conomic.com/customers/1?demo=true"" }, ""bookedInvoice"": { ""bookedInvoiceNumber"": 10286, ""self"": ""https://restapi.e-conomic.com/invoices/booked/10286?demo=true"" }, ""invoiceNumber"": 10286, ""remainder"": 10.00, ""remainderInBaseCurrency"": 10.00, ""self"": ""https://restapi.e-conomic.com/entries/2722?demo=true"" }, { ""account"": { ""accountNumber"": 5600, ""self"": ""https://restapi.e-conomic.com/accounts/5600?demo=true"" }, ""amount"": 10.00, ""amountInBaseCurrency"": 10.00, ""currency"": ""DKK"", ""date"": ""2017-04-21"", ""dueDate"": ""2017-05-05"", ""entryNumber"": 2724, ""text"": ""Invoice"", ""entryType"": ""customerInvoice"", ""voucherNumber"": 10287, ""customer"": { ""customerNumber"": 1, ""self"": ""https://restapi.e-conomic.com/customers/1?demo=true"" }, ""bookedInvoice"": { ""bookedInvoiceNumber"": 10287, ""self"": ""https://restapi.e-conomic.com/invoices/booked/10287?demo=true"" }, ""invoiceNumber"": 10287, ""remainder"": 10.00, ""remainderInBaseCurrency"": 10.00, ""self"": ""https://restapi.e-conomic.com/entries/2724?demo=true"" }, { ""account"": { ""accountNumber"": 5600, ""self"": ""https://restapi.e-conomic.com/accounts/5600?demo=true"" }, ""amount"": 10.00, ""amountInBaseCurrency"": 10.00, ""currency"": ""DKK"", ""date"": ""2017-04-21"", ""dueDate"": ""2017-05-05"", ""entryNumber"": 2726, ""text"": ""Invoice"", ""entryType"": ""customerInvoice"", ""voucherNumber"": 10288, ""customer"": { ""customerNumber"": 1, ""self"": ""https://restapi.e-conomic.com/customers/1?demo=true"" }, ""bookedInvoice"": { ""bookedInvoiceNumber"": 10288, ""self"": ""https://restapi.e-conomic.com/invoices/booked/10288?demo=true"" }, ""invoiceNumber"": 10288, ""remainder"": 10.00, ""remainderInBaseCurrency"": 10.00, ""self"": ""https://restapi.e-conomic.com/entries/2726?demo=true"" }, { ""account"": { ""accountNumber"": 5600, ""self"": ""https://restapi.e-conomic.com/accounts/5600?demo=true"" }, ""amount"": 93.86, ""amountInBaseCurrency"": 93.86, ""currency"": ""DKK"", ""date"": ""2017-04-04"", ""dueDate"": ""2017-04-12"", ""entryNumber"": 2733, ""text"": ""Invoice"", ""entryType"": ""customerInvoice"", ""voucherNumber"": 10290, ""customer"": { ""customerNumber"": 1, ""self"": ""https://restapi.e-conomic.com/customers/1?demo=true"" }, ""bookedInvoice"": { ""bookedInvoiceNumber"": 10290, ""self"": ""https://restapi.e-conomic.com/invoices/booked/10290?demo=true"" }, ""invoiceNumber"": 10290, ""remainder"": 93.86, ""remainderInBaseCurrency"": 93.86, ""self"": ""https://restapi.e-conomic.com/entries/2733?demo=true"" }, { ""account"": { ""accountNumber"": 5600, ""self"": ""https://restapi.e-conomic.com/accounts/5600?demo=true"" }, ""amount"": 93.86, ""amountInBaseCurrency"": 93.86, ""currency"": ""DKK"", ""date"": ""2017-04-04"", ""dueDate"": ""2017-04-12"", ""entryNumber"": 2736, ""text"": ""Invoice"", ""entryType"": ""customerInvoice"", ""voucherNumber"": 10291, ""customer"": { ""customerNumber"": 1, ""self"": ""https://restapi.e-conomic.com/customers/1?demo=true"" }, ""bookedInvoice"": { ""bookedInvoiceNumber"": 10291, ""self"": ""https://restapi.e-conomic.com/invoices/booked/10291?demo=true"" }, ""invoiceNumber"": 10291, ""remainder"": 93.86, ""remainderInBaseCurrency"": 93.86, ""self"": ""https://restapi.e-conomic.com/entries/2736?demo=true"" }, { ""account"": { ""accountNumber"": 5600, ""self"": ""https://restapi.e-conomic.com/accounts/5600?demo=true"" }, ""amount"": 93.86, ""amountInBaseCurrency"": 93.86, ""currency"": ""DKK"", ""date"": ""2017-04-05"", ""dueDate"": ""2017-04-13"", ""entryNumber"": 2739, ""text"": ""Invoice"", ""entryType"": ""customerInvoice"", ""voucherNumber"": 10292, ""customer"": { ""customerNumber"": 1, ""self"": ""https://restapi.e-conomic.com/customers/1?demo=true"" }, ""bookedInvoice"": { ""bookedInvoiceNumber"": 10292, ""self"": ""https://restapi.e-conomic.com/invoices/booked/10292?demo=true"" }, ""invoiceNumber"": 10292, ""remainder"": 93.86, ""remainderInBaseCurrency"": 93.86, ""self"": ""https://restapi.e-conomic.com/entries/2739?demo=true"" }, { ""account"": { ""accountNumber"": 5600, ""self"": ""https://restapi.e-conomic.com/accounts/5600?demo=true"" }, ""amount"": 93.86, ""amountInBaseCurrency"": 93.86, ""currency"": ""DKK"", ""date"": ""2017-04-06"", ""dueDate"": ""2017-04-14"", ""entryNumber"": 2742, ""text"": ""Invoice"", ""entryType"": ""customerInvoice"", ""voucherNumber"": 10293, ""customer"": { ""customerNumber"": 1, ""self"": ""https://restapi.e-conomic.com/customers/1?demo=true"" }, ""bookedInvoice"": { ""bookedInvoiceNumber"": 10293, ""self"": ""https://restapi.e-conomic.com/invoices/booked/10293?demo=true"" }, ""invoiceNumber"": 10293, ""remainder"": 93.86, ""remainderInBaseCurrency"": 93.86, ""self"": ""https://restapi.e-conomic.com/entries/2742?demo=true"" }, { ""account"": { ""accountNumber"": 5600, ""self"": ""https://restapi.e-conomic.com/accounts/5600?demo=true"" }, ""amount"": 93.86, ""amountInBaseCurrency"": 93.86, ""currency"": ""DKK"", ""date"": ""2017-04-06"", ""dueDate"": ""2017-04-14"", ""entryNumber"": 2745, ""text"": ""Invoice"", ""entryType"": ""customerInvoice"", ""voucherNumber"": 10294, ""customer"": { ""customerNumber"": 1, ""self"": ""https://restapi.e-conomic.com/customers/1?demo=true"" }, ""bookedInvoice"": { ""bookedInvoiceNumber"": 10294, ""self"": ""https://restapi.e-conomic.com/invoices/booked/10294?demo=true"" }, ""invoiceNumber"": 10294, ""remainder"": 93.86, ""remainderInBaseCurrency"": 93.86, ""self"": ""https://restapi.e-conomic.com/entries/2745?demo=true"" }, { ""account"": { ""accountNumber"": 5600, ""self"": ""https://restapi.e-conomic.com/accounts/5600?demo=true"" }, ""amount"": 93.86, ""amountInBaseCurrency"": 93.86, ""currency"": ""DKK"", ""date"": ""2017-04-06"", ""dueDate"": ""2017-04-14"", ""entryNumber"": 2748, ""text"": ""Invoice"", ""entryType"": ""customerInvoice"", ""voucherNumber"": 10295, ""customer"": { ""customerNumber"": 1, ""self"": ""https://restapi.e-conomic.com/customers/1?demo=true"" }, ""bookedInvoice"": { ""bookedInvoiceNumber"": 10295, ""self"": ""https://restapi.e-conomic.com/invoices/booked/10295?demo=true"" }, ""invoiceNumber"": 10295, ""remainder"": 93.86, ""remainderInBaseCurrency"": 93.86, ""self"": ""https://restapi.e-conomic.com/entries/2748?demo=true"" }, { ""account"": { ""accountNumber"": 5600, ""self"": ""https://restapi.e-conomic.com/accounts/5600?demo=true"" }, ""amount"": 93.86, ""amountInBaseCurrency"": 93.86, ""currency"": ""DKK"", ""date"": ""2017-04-06"", ""dueDate"": ""2017-04-14"", ""entryNumber"": 2751, ""text"": ""Invoice"", ""entryType"": ""customerInvoice"", ""voucherNumber"": 10296, ""customer"": { ""customerNumber"": 1, ""self"": ""https://restapi.e-conomic.com/customers/1?demo=true"" }, ""bookedInvoice"": { ""bookedInvoiceNumber"": 10296, ""self"": ""https://restapi.e-conomic.com/invoices/booked/10296?demo=true"" }, ""invoiceNumber"": 10296, ""remainder"": 93.86, ""remainderInBaseCurrency"": 93.86, ""self"": ""https://restapi.e-conomic.com/entries/2751?demo=true"" }, { ""account"": { ""accountNumber"": 5600, ""self"": ""https://restapi.e-conomic.com/accounts/5600?demo=true"" }, ""amount"": 93.86, ""amountInBaseCurrency"": 93.86, ""currency"": ""DKK"", ""date"": ""2017-04-06"", ""dueDate"": ""2017-04-14"", ""entryNumber"": 2754, ""text"": ""Invoice"", ""entryType"": ""customerInvoice"", ""voucherNumber"": 10297, ""customer"": { ""customerNumber"": 1, ""self"": ""https://restapi.e-conomic.com/customers/1?demo=true"" }, ""bookedInvoice"": { ""bookedInvoiceNumber"": 10297, ""self"": ""https://restapi.e-conomic.com/invoices/booked/10297?demo=true"" }, ""invoiceNumber"": 10297, ""remainder"": 93.86, ""remainderInBaseCurrency"": 93.86, ""self"": ""https://restapi.e-conomic.com/entries/2754?demo=true"" }, { ""account"": { ""accountNumber"": 5600, ""self"": ""https://restapi.e-conomic.com/accounts/5600?demo=true"" }, ""amount"": 93.86, ""amountInBaseCurrency"": 93.86, ""currency"": ""DKK"", ""date"": ""2017-04-06"", ""dueDate"": ""2017-04-14"", ""entryNumber"": 2757, ""text"": ""Invoice"", ""entryType"": ""customerInvoice"", ""voucherNumber"": 10298, ""customer"": { ""customerNumber"": 1, ""self"": ""https://restapi.e-conomic.com/customers/1?demo=true"" }, ""bookedInvoice"": { ""bookedInvoiceNumber"": 10298, ""self"": ""https://restapi.e-conomic.com/invoices/booked/10298?demo=true"" }, ""invoiceNumber"": 10298, ""remainder"": 93.86, ""remainderInBaseCurrency"": 93.86, ""self"": ""https://restapi.e-conomic.com/entries/2757?demo=true"" } ], ""pagination"": { ""maxPageSizeAllowed"": 1000, ""skipPages"": 0, ""pageSize"": 20, ""results"": 48, ""resultsWithoutFilter"": 1673, ""firstPage"": ""https://restapi.e-conomic.com/accounting-years/2017/entries?demo=true&filter=customer.customerNumber%24eq%3a1&skippages=0&pagesize=20"", ""nextPage"": ""https://restapi.e-conomic.com/accounting-years/2017/entries?demo=true&filter=customer.customerNumber%24eq%3a1&skippages=1&pagesize=20"", ""lastPage"": ""https://restapi.e-conomic.com/accounting-years/2017/entries?demo=true&filter=customer.customerNumber%24eq%3a1&skippages=2&pagesize=20"" }, ""self"": ""https://restapi.e-conomic.com/accounting-years/2017/entries?demo=true&filter=customer.customerNumber%24eq%3a1"" }");

            var httpClient = new HttpClient(handlerMock)
            {
                BaseAddress = new Uri("https://restapi.e-conomic.com/"),
            };

            var subjectUnderTest = new EconomicClient(httpClient, "demo", "demo");
            var result = await subjectUnderTest.GetAccountEntries(2017, 1);

            result.Should().NotBeNull();
            result.Count.Should().Be(20);
            handlerMock.NumberOfCalls.Should().Be(1);
            handlerMock.Request.Method.Should().Be(HttpMethod.Get);
            handlerMock.Request.RequestUri.Should().Be(new Uri("https://restapi.e-conomic.com/accounting-years/2017/entries?skippages=0&pagesize=1000&filter=customer.customerNumber$eq:1$and:entryType$ne:systemEntry&sort=date"));
        }

        private class MockHttpMessageHandler : HttpMessageHandler
        {
            private readonly HttpStatusCode _statusCode;
            private readonly string _response;

            public int NumberOfCalls { get; private set; }
            public HttpRequestMessage Request { get; private set; }

            public MockHttpMessageHandler(HttpStatusCode statusCode, string response)
            {
                _statusCode = statusCode;
                _response = response;
            }

            protected override Task<HttpResponseMessage> SendAsync(HttpRequestMessage request,
                CancellationToken cancellationToken)
            {
                NumberOfCalls++;
                Request = request;
                return Task.FromResult(new HttpResponseMessage
                {
                    StatusCode = _statusCode,
                    Content = new StringContent(_response)
                });
            }
        }
    }
}
